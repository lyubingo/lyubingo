<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>关键词过滤&&给图片添加水印 | LYUBINGO BLOG</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="lyubingo, lyubingo blog, 前端博客, 前端, 程序员, 前端开发, 全栈开发, node.js, javascript, hexo"><meta name="description" content="个人博客，用于分享一些在日常学习工作甚至于生活中遇到的一些比较有趣的东西。七荤八素，胡言乱语，望各位看官见谅。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://lyubingo.github.io/2019/04/10/16关键词and给图片加水印/index.html"><link rel="icon" type="image/png" href="/img/lyubingoY.icon" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="Lyubingo blog"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(http://oo12ugek5.bkt.clouddn.com/blog/images/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="Lyubingo blog" alt="Lyubingo blog"><img src="http://www.hncryp.com/lyubingo.png" alt="Lyubingo blog"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://lyubingo.github.io/img/mac.jpg" alt="关键词过滤&&给图片添加水印"></div><header class="post__info"><h1 class="post__title">关键词过滤&&给图片添加水印</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://lyubingo.github.io">lyubingo</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-04-10</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/工作日常/">工作日常</a></li></ul></div></div></header><div class="post__content"><h1 id="屏蔽敏感词"><a href="#屏蔽敏感词" class="headerlink" title="屏蔽敏感词"></a>屏蔽敏感词</h1><p>boss给了我一个excel，要我把这些关键词显示为<em>**</em></p><p>思路：将excel关键词都处理进数组，然后foreach该数组，再与文本进行匹配，存在则进行替换（preg_replace).</p><p>但是一般这种，都会去github找轮子——找了好几个轮子（3个以上），TrilTree应该不错，但是要用composrr安装，考虑到线上环境，最终选择了只需要引用就能使用的轮子：</p><p><a href="https://github.com/nowgoo/dict" target="_blank" rel="noopener">https://github.com/nowgoo/dict</a></p><p>拷贝该SimpleDict.php文件至Vendor文件夹，使用Vendor()函数引入即可使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * A simple dictionary</span><br><span class="line"> *</span><br><span class="line"> * 1. prepare a text file, format:</span><br><span class="line"> *   word1&lt;tab&gt;value1</span><br><span class="line"> *   word2&lt;tab&gt;value2</span><br><span class="line"> *   ...</span><br><span class="line"> *</span><br><span class="line"> * 2. make a dictionary file:</span><br><span class="line"> *   SimpleDict::make(&quot;text_file_path&quot;, &quot;output_dict_path&quot;);</span><br><span class="line"> *</span><br><span class="line"> * 3. play with it!</span><br><span class="line"> *  $dict = new SimpleDict(&quot;dict_path&quot;);</span><br><span class="line"> *  $result = $dict-&gt;search(&quot;some text here...&quot;);</span><br><span class="line"> *</span><br><span class="line"> * $result format:</span><br><span class="line"> *   array(</span><br><span class="line"> *     &apos;word1&apos; =&gt; array(&apos;value&apos; =&gt; &apos;value1&apos;, &apos;count&apos; =&gt; &apos;count1&apos;),</span><br><span class="line"> *     ...</span><br><span class="line"> *   )</span><br><span class="line"> *</span><br><span class="line"> * @link https://github.com/nowgoo/dict/</span><br><span class="line"> * @author Nowgoo &lt;nowgoo@gmail.com&gt;</span><br><span class="line"> * http://www.opensource.org/licenses/mit-license.html  MIT License</span><br><span class="line"> */</span><br><span class="line">class SimpleDict</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * char for padding value</span><br><span class="line">     */</span><br><span class="line">    const CHAR_PAD = &apos; &apos;;</span><br><span class="line">    /**</span><br><span class="line">     * stop chars</span><br><span class="line">     */</span><br><span class="line">    const CHAR_STOP = &apos;,.? &apos;;</span><br><span class="line">    /**</span><br><span class="line">     * file handle</span><br><span class="line">     * @var resource</span><br><span class="line">     */</span><br><span class="line">    private $file;</span><br><span class="line">    /**</span><br><span class="line">     * fixed row length</span><br><span class="line">     * @var int</span><br><span class="line">     */</span><br><span class="line">    private $rowLength = 0;</span><br><span class="line">    /**</span><br><span class="line">     * fixed value length</span><br><span class="line">     * @var int</span><br><span class="line">     */</span><br><span class="line">    private $valueLength = 0;</span><br><span class="line">    /**</span><br><span class="line">     * first chars cache</span><br><span class="line">     * @var array</span><br><span class="line">     */</span><br><span class="line">    private $start = array();</span><br><span class="line">    public function __construct($file)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file = fopen($file, &apos;r&apos;);</span><br><span class="line">        $unpack = unpack(&quot;n3&quot;, fread($this-&gt;file, 6));</span><br><span class="line">        $count  = $unpack[1];</span><br><span class="line">        $this-&gt;valueLength = $unpack[2];</span><br><span class="line">        $this-&gt;rowLength   = $unpack[3];</span><br><span class="line">        foreach ($this-&gt;readLine(6, $count) as $line) &#123;</span><br><span class="line">            list($fChar, $fCount, $fOffset, $fValue) = $line;</span><br><span class="line">            $this-&gt;start[$fChar] = array($fCount, $fOffset, $fValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        unset($this-&gt;start);</span><br><span class="line">        fclose($this-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * search $str, return words found in dict:</span><br><span class="line">     * array(</span><br><span class="line">     *   &apos;word1&apos; =&gt; array(&apos;value&apos; =&gt; &apos;value1&apos;, &apos;count&apos; =&gt; &apos;count1&apos;),</span><br><span class="line">     *   ...</span><br><span class="line">     * )</span><br><span class="line">     * @param string $str</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    public function search($str)</span><br><span class="line">    &#123;</span><br><span class="line">        $ret   = array();</span><br><span class="line">        $itr   = new CharIterator($str);</span><br><span class="line">        $stops = self::CHAR_STOP;</span><br><span class="line">        $buff  = array();</span><br><span class="line">        foreach ($itr as $char) &#123;</span><br><span class="line">            if (strpos($stops, $char) !== false) &#123;</span><br><span class="line">                $buff = array();</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            foreach ($buff as $prefix =&gt; $next) &#123;</span><br><span class="line">                $newPrefix = $prefix.$char;</span><br><span class="line">                list($count, $offset, $value) = $this-&gt;findWord($char, $next[0], $next[1]);</span><br><span class="line">                if (!empty($value)) &#123;</span><br><span class="line">                    if (isset($ret[$newPrefix])) &#123;</span><br><span class="line">                        $ret[$newPrefix][&apos;count&apos;]++;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        $ret[$newPrefix] = array(</span><br><span class="line">                            &apos;count&apos; =&gt; 1,</span><br><span class="line">                            &apos;value&apos; =&gt; $value</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if ($count &gt; 0) &#123;</span><br><span class="line">                    $buff[$newPrefix] = array($count, $offset);</span><br><span class="line">                &#125;</span><br><span class="line">                unset($buff[$prefix]);</span><br><span class="line">            &#125;</span><br><span class="line">            if (isset($this-&gt;start[$char])) &#123;</span><br><span class="line">                list($count, $offset, $value) = $this-&gt;start[$char];</span><br><span class="line">                if (!empty($value)) &#123;</span><br><span class="line">                    if (isset($ret[$char])) &#123;</span><br><span class="line">                        $ret[$char][&apos;count&apos;]++;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        $ret[$char] = array(</span><br><span class="line">                            &apos;count&apos; =&gt; 1,</span><br><span class="line">                            &apos;value&apos; =&gt; $value</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if ($count &gt; 0 &amp;&amp; !isset($buff[$char])) &#123;</span><br><span class="line">                    $buff[$char] = array($count, $offset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * replace words to $to</span><br><span class="line">     * if $to is callable, replace to call_user_func($to, $word, $value)</span><br><span class="line">     * @param string $str</span><br><span class="line">     * @param mixed $to</span><br><span class="line">     * @return string</span><br><span class="line">     */</span><br><span class="line">    public function replace($str, $to)</span><br><span class="line">    &#123;</span><br><span class="line">        $ret   = &apos;&apos;;</span><br><span class="line">        $itr   = new CharIterator($str);</span><br><span class="line">        $stops = self::CHAR_STOP;</span><br><span class="line">        $buff = &apos;&apos;;</span><br><span class="line">        $size   = 0;</span><br><span class="line">        $offset = 0;</span><br><span class="line">        $buffValue = array();</span><br><span class="line">        foreach ($itr as $char) &#123;</span><br><span class="line">            if (strpos($stops, $char) !== false) &#123;</span><br><span class="line">                if (empty($buffValue)) &#123;</span><br><span class="line">                    $ret .= $buff.$char;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $ret .= $this-&gt;replaceTo($buffValue[0], $buffValue[1], $to)</span><br><span class="line">                        .substr($buff, strlen($buffValue[0])).$char;</span><br><span class="line">                &#125;</span><br><span class="line">                $buff = &apos;&apos;;</span><br><span class="line">                $buffValue = array();</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if ($buff !== &apos;&apos;) &#123;</span><br><span class="line">                list($fCount, $fOffset, $fValue) =</span><br><span class="line">                    $this-&gt;findWord($char, $size, $offset);</span><br><span class="line">                if ($fValue === null) &#123;</span><br><span class="line">                    if (empty($buffValue)) &#123;</span><br><span class="line">                        $ret .= $buff;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        $ret .= $this-&gt;replaceTo($buffValue[0], $buffValue[1], $to)</span><br><span class="line">                            .substr($buff, strlen($buffValue[0]));</span><br><span class="line">                    &#125;</span><br><span class="line">                    $buff = &apos;&apos;;</span><br><span class="line">                    $buffValue = array();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    if ($fCount &gt; 0) &#123;</span><br><span class="line">                        $buff  .= $char;</span><br><span class="line">                        $size   = $fCount;</span><br><span class="line">                        $offset = $fOffset;</span><br><span class="line">                        if (!empty($fValue)) &#123;</span><br><span class="line">                            $buffValue = array($buff, $fValue);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        $ret .= $this-&gt;replaceTo($buff.$char, $fValue, $to);</span><br><span class="line">                        $buff = &apos;&apos;;</span><br><span class="line">                        $buffValue = array();</span><br><span class="line">                    &#125;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (isset($this-&gt;start[$char])) &#123;</span><br><span class="line">                list($fCount, $fOffset, $fValue) = $this-&gt;start[$char];</span><br><span class="line">                if ($fCount &gt; 0) &#123;</span><br><span class="line">                    $buff   = $char;</span><br><span class="line">                    $size   = $fCount;</span><br><span class="line">                    $offset = $fOffset;</span><br><span class="line">                    if(!empty($fValue))</span><br><span class="line">                        $buffValue = array($buff, $fValue);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $ret .= $this-&gt;replaceTo($char, $fValue, $to);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $ret .= $char;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if($buff !== &apos;&apos;) &#123;</span><br><span class="line">            if(empty($buffValue))</span><br><span class="line">                $ret .= $buff;</span><br><span class="line">            else</span><br><span class="line">                $ret .= $this-&gt;replaceTo($buffValue[0], $buffValue[1], $to) . substr($buff, strlen($buffValue[0]));</span><br><span class="line">        &#125;</span><br><span class="line">        return $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    public function replaceTo($word, $value, $to) &#123;</span><br><span class="line">        return is_callable($to)</span><br><span class="line">            ? call_user_func($to, $word, $value)</span><br><span class="line">            : $to;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * from $offset, find $char, up to $count record</span><br><span class="line">     * @param string $char</span><br><span class="line">     * @param int $count</span><br><span class="line">     * @param int $offset</span><br><span class="line">     * @return array($count, $offset, $value)</span><br><span class="line">     */</span><br><span class="line">    public function findWord($char, $count, $offset)</span><br><span class="line">    &#123;</span><br><span class="line">        fseek($this-&gt;file, $offset);</span><br><span class="line">        $len  = $this-&gt;rowLength;</span><br><span class="line">        $data = fread($this-&gt;file, $count * $len);</span><br><span class="line">        for ($i = 0; $i &lt; $count; $i++) &#123;</span><br><span class="line">            $row = substr($data, $i * $len, $len);</span><br><span class="line">            $un  = unpack(&quot;c3char/ncount/Noffset/c*value&quot;, $row);</span><br><span class="line">            $fChar   = rtrim(chr($un[&apos;char1&apos;]).chr($un[&apos;char2&apos;]).chr($un[&apos;char3&apos;]));</span><br><span class="line">            if ($fChar !== $char) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            $fCount  = $un[&apos;count&apos;];</span><br><span class="line">            $fOffset = $un[&apos;offset&apos;];</span><br><span class="line">            $fValue  = &apos;&apos;;</span><br><span class="line">            for ($j = 1; $j &lt;= $this-&gt;rowLength-9; $j++) &#123;</span><br><span class="line">                $v = $un[&apos;value&apos;.$j];</span><br><span class="line">                if ($v == 32) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                $fValue .= chr($v);</span><br><span class="line">            &#125;</span><br><span class="line">            return array($fCount, $fOffset, $fValue);</span><br><span class="line">        &#125;</span><br><span class="line">        return array(0, 0, null);</span><br><span class="line">    &#125;</span><br><span class="line">    private function readLine($offset, $size)</span><br><span class="line">    &#123;</span><br><span class="line">        $ret = array();</span><br><span class="line">        fseek($this-&gt;file, $offset);</span><br><span class="line">        $data   = fread($this-&gt;file, $size * $this-&gt;rowLength);</span><br><span class="line">        for ($i =0; $i &lt; $size; $i++) &#123;</span><br><span class="line">            $row = substr($data, $i * $this-&gt;rowLength, $this-&gt;rowLength);</span><br><span class="line">            $un  = unpack(&quot;c3char/ncount/Noffset/c*value&quot;, $row);</span><br><span class="line">            $fChar   = rtrim(chr($un[&apos;char1&apos;]).chr($un[&apos;char2&apos;]).chr($un[&apos;char3&apos;]));</span><br><span class="line">            $fCount  = $un[&apos;count&apos;];</span><br><span class="line">            $fOffset = $un[&apos;offset&apos;];</span><br><span class="line">            $fValue  = &apos;&apos;;</span><br><span class="line">            for ($j = 1; $j &lt;= $this-&gt;rowLength-9; $j++) &#123;</span><br><span class="line">                $v = $un[&apos;value&apos;.$j];</span><br><span class="line">                if ($v == 32) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                $fValue .= chr($v);</span><br><span class="line">            &#125;</span><br><span class="line">            $ret[] = array($fChar, $fCount, $fOffset, $fValue);</span><br><span class="line">        &#125;</span><br><span class="line">        return $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * make a dict file $output from $input</span><br><span class="line">     * @param string $input</span><br><span class="line">     * @param string $output</span><br><span class="line">     */</span><br><span class="line">    public static function make($input, $output)</span><br><span class="line">    &#123;</span><br><span class="line">        $data = array();</span><br><span class="line">        $fp   = fopen($input, &apos;r&apos;);</span><br><span class="line">        $vLen = 0;</span><br><span class="line">        while ($line = fgets($fp, 1024)) &#123;</span><br><span class="line">            list($word, $value) = explode(&quot;\t&quot;, rtrim($line));</span><br><span class="line">            $itr = new CharIterator($word);</span><br><span class="line">            $pfx = &apos;&apos;;</span><br><span class="line">            foreach ($itr as $char) &#123;</span><br><span class="line">                if (!isset($data[$pfx][&apos;next&apos;])</span><br><span class="line">                    || !in_array($char, $data[$pfx][&apos;next&apos;])) &#123;</span><br><span class="line">                    $data[$pfx][&apos;next&apos;][] = $char;</span><br><span class="line">                &#125;</span><br><span class="line">                $pfx .= $char;</span><br><span class="line">            &#125;</span><br><span class="line">            if (strlen($value) &gt; $vLen) &#123;</span><br><span class="line">                $vLen = strlen($value);</span><br><span class="line">            &#125;</span><br><span class="line">            $data[$word][&apos;value&apos;] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose($fp);</span><br><span class="line">        sort($data[&apos;&apos;][&apos;next&apos;], SORT_STRING);</span><br><span class="line">        $stack  = array(array_fill_keys($data[&apos;&apos;][&apos;next&apos;], 0));</span><br><span class="line">        $prefix = array();</span><br><span class="line">        $fp = fopen($output, &apos;w&apos;);</span><br><span class="line">        // header: count, valueLength, rowLength</span><br><span class="line">        $line = pack(&quot;nnn&quot;, count($stack[0]), $vLen, $vLen+9);</span><br><span class="line">        fwrite($fp, $line);</span><br><span class="line">        $offset = strlen($line);</span><br><span class="line">        do &#123;</span><br><span class="line">            foreach ($stack[0] as $char =&gt; &amp;$addr) &#123;</span><br><span class="line">                if ($addr &gt; 0) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                $line = str_pad($char, 3, self::CHAR_PAD)</span><br><span class="line">                    .pack(&quot;nN&quot;, 0, 0)</span><br><span class="line">                    .str_repeat(self::CHAR_PAD, $vLen);</span><br><span class="line">                fwrite($fp, $line);</span><br><span class="line">                $addr = $offset;</span><br><span class="line">                $offset += strlen($line);</span><br><span class="line">            &#125;</span><br><span class="line">            $nextKeys = array_keys($stack[0]);</span><br><span class="line">            $nextChar = $nextKeys[0];</span><br><span class="line">            $next     = $data[implode(&apos;&apos;, $prefix).$nextChar];</span><br><span class="line">            $nextSize = isset($next[&apos;next&apos;]) ? count($next[&apos;next&apos;]) : 0;</span><br><span class="line">            $nextVal  = isset($next[&apos;value&apos;]) ? $next[&apos;value&apos;] : &apos;&apos;;</span><br><span class="line">            $line     = pack(&quot;nN&quot;, $nextSize, $offset)</span><br><span class="line">                .str_pad($nextVal, $vLen, self::CHAR_PAD);</span><br><span class="line">            fseek($fp, $stack[0][$nextChar] + 3);</span><br><span class="line">            fwrite($fp, $line);</span><br><span class="line">            fseek($fp, $offset);</span><br><span class="line">            if (isset($next[&apos;next&apos;])) &#123;</span><br><span class="line">                $prefix[] = $nextChar;</span><br><span class="line">                sort($next[&apos;next&apos;], SORT_STRING);</span><br><span class="line">                array_unshift($stack, array_fill_keys($next[&apos;next&apos;], 0));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                unset($stack[0][$nextChar]);</span><br><span class="line">            &#125;</span><br><span class="line">            while (empty($stack[0]) &amp;&amp; !empty($stack)) &#123;</span><br><span class="line">                array_shift($stack);</span><br><span class="line">                if (empty($stack)) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                $keys = array_keys($stack[0]);</span><br><span class="line">                unset($stack[0][$keys[0]]);</span><br><span class="line">                array_pop($prefix);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while (!empty($stack));</span><br><span class="line">        echo &quot;done\n&quot;;</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class CharIterator implements Iterator</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * @var string</span><br><span class="line">     */</span><br><span class="line">    private $str;</span><br><span class="line">    /**</span><br><span class="line">     * @var string</span><br><span class="line">     */</span><br><span class="line">    private $char;</span><br><span class="line">    /**</span><br><span class="line">     * @var int</span><br><span class="line">     */</span><br><span class="line">    private $length = 0;</span><br><span class="line">    /**</span><br><span class="line">     * @var int</span><br><span class="line">     */</span><br><span class="line">    private $index = 0;</span><br><span class="line">    /**</span><br><span class="line">     * @var int</span><br><span class="line">     */</span><br><span class="line">    private $offset = 0;</span><br><span class="line">    public function __construct($str) &#123;</span><br><span class="line">        $this-&gt;str = $str;</span><br><span class="line">    &#125;</span><br><span class="line">    public function current()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;char;</span><br><span class="line">    &#125;</span><br><span class="line">    public function key()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;offset;</span><br><span class="line">    &#125;</span><br><span class="line">    public function next()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;offset &gt;= $this-&gt;length) &#123;</span><br><span class="line">            $this-&gt;char = &apos;&apos;;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $i   = $this-&gt;offset;</span><br><span class="line">        $c   = $this-&gt;str[$i];</span><br><span class="line">        $ord = ord($c);</span><br><span class="line">        if ($ord &lt; 128) &#123;</span><br><span class="line">            $this-&gt;char = $c;</span><br><span class="line">        &#125; elseif ($ord &lt; 224) &#123;</span><br><span class="line">            $this-&gt;char = $c.$this-&gt;str[++$i];</span><br><span class="line">        &#125; elseif ($ord &lt; 240) &#123;</span><br><span class="line">            $this-&gt;char = $c.$this-&gt;str[++$i].$this-&gt;str[++$i];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;char = $c.$this-&gt;str[++$i].$this-&gt;str[++$i].$this-&gt;str[++$i];</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;offset = $i+1;</span><br><span class="line">        $this-&gt;index += 1;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    public function rewind()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;offset = 0;</span><br><span class="line">        $this-&gt;index  = 0;</span><br><span class="line">        $this-&gt;length = strlen($this-&gt;str);</span><br><span class="line">        $this-&gt;char   = &apos;&apos;;</span><br><span class="line">        $this-&gt;next();</span><br><span class="line">    &#125;</span><br><span class="line">    public function valid()</span><br><span class="line">    &#123;</span><br><span class="line">        return ($this-&gt;char !== &apos;&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在本地进行demo测试的时候，竟然不会用。。后面求助建哥才懂。</p><p>需要准备一个txt文件，格式为&lt;敏感词&gt;<tab>&lt;值&gt;，一行一个排列，然后使用make方法，生成一个全新的文件，然后new的时候把该文件传入，一共三个方法可以使用，其中‘some text here’，指的是需要检测的文本。（我几乎全文抄下来是害怕github链接失效）</tab></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">准备文本格式的词库</span><br><span class="line"></span><br><span class="line">首先准备一个文本文件，每个词占一行。格式：</span><br><span class="line"></span><br><span class="line">词语&lt;tab&gt;值</span><br><span class="line"></span><br><span class="line">生成 SimpleDict 专用词库</span><br><span class="line"></span><br><span class="line">SimpleDict::make(&quot;text_file_path&quot;, &quot;output_dict_path&quot;);</span><br><span class="line">搜索</span><br><span class="line"></span><br><span class="line">$dict = new SimpleDict(&quot;dict_path&quot;);</span><br><span class="line">$result = $dict-&gt;search(&quot;some text here...&quot;);</span><br><span class="line"></span><br><span class="line">/* $result 的格式：</span><br><span class="line">array(</span><br><span class="line">  &apos;word1&apos; =&gt; array(&apos;value&apos; =&gt; &apos;value1&apos;, &apos;count&apos; =&gt; &apos;count1&apos;),</span><br><span class="line">  ...</span><br><span class="line">)*/</span><br><span class="line">替换</span><br><span class="line"></span><br><span class="line">// 简单替换</span><br><span class="line">$replaced = $dict-&gt;replace(&quot;some text here...&quot;, &quot;**&quot;);</span><br><span class="line">// 高级替换</span><br><span class="line">$replaced = $dict-&gt;replace(&quot;some text here...&quot;, function($word, $value) &#123;</span><br><span class="line">  return &quot;[$word -&gt; $value]&quot;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="但是！！！重点来了！，当我把这些更新上线的时候，线上直接502了。"><a href="#但是！！！重点来了！，当我把这些更新上线的时候，线上直接502了。" class="headerlink" title="但是！！！重点来了！，当我把这些更新上线的时候，线上直接502了。"></a>但是！！！重点来了！，当我把这些更新上线的时候，线上直接502了。</h3><p>本地和测试环境都无法预测到这样的情况，原因是该功能导致内存溢出，cpu超出负荷，所以线上直接宕机。不过在运维的帮助下，很快就取得了回复。</p><p>审视自己的代码，发现每次make其实生成的都是同一个文件，于是考虑把make去掉，并且在测试服配合做压力测试。（还有第二个思路，即新增内容时处理内容，展示给用户时无需做处理，而对于之前已经存在内容，则需要跑脚本进行处理）</p><p>但是我不想放弃，于是去掉make方法，一个模块一个模块的更新上线，最终没有出现内存溢出的情况。</p><p>说到压力测试，其实无法模拟线上的真实情况，不过还是要提一下；</p><blockquote><p>yum install httpd-tools</p></blockquote><p>最常使用的命令为：</p><blockquote><p>ab -n 100 -c 100 <a href="https://www.baidu.com/" target="_blank" rel="noopener">https://www.baidu.com/</a></p></blockquote><p>ab测试，-n [请求次数] -c [并发数]， 后面接IP或者域名都可以，如果是测试首页， 要加“/”， 不然会报错， 然后观察线上cpu和mem使用率即可。</p><p>不过可能不准，测试服 n 和 c 都弄成8000， cpu和mem都扛的住，但是现在知道关键要看 load average 值</p><h2 id="给图片加水印"><a href="#给图片加水印" class="headerlink" title="给图片加水印"></a>给图片加水印</h2><p>如果从头自己研究gd库。。。直接去github， 链接：</p><p><a href="https://github.com/byron1655/imagefilter" target="_blank" rel="noopener">github.com/byron1655/imagefilter</a></p><p>照例引入，然后使用即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * 样例:example1</span><br><span class="line"> * $job = array(&apos;scaling&apos;=&gt;[&apos;size&apos;=&gt;&quot;300,500&quot;],</span><br><span class="line"> * &apos;clipping&apos;=&gt;[&apos;position&apos;=&gt;&apos;0,0&apos;, &apos;size&apos;=&gt;&apos;150,50&apos;],</span><br><span class="line"> * &apos;watermark&apos;=&gt;[&apos;mark&apos;=&gt;&apos;logo.png&apos;,&apos;position&apos;=&gt;0]</span><br><span class="line"> * &apos;imagetext&apos;=&gt;[&apos;text&apos;=&gt;&apos;ouropera.net&apos;,&apos;fontsize&apos;=&gt;&apos;10&apos;,&apos;fontfamily&apos;=&gt;&apos;msyh&apos;]);</span><br><span class="line"> * $image = new ImageFilter(&quot;1.jpg&quot;, $job, &quot;1_1.jpg&quot;);</span><br><span class="line"> * $image-&gt;outimage();</span><br><span class="line"> * 样例:end</span><br><span class="line"> *</span><br><span class="line"> * @authors byron (www.ouropera.net)</span><br><span class="line"> * @date    2015-11-04 11:54:18</span><br><span class="line"> * @version 1.2</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">class ImageFilter &#123;</span><br><span class="line">	//使用的功能编号,1为图片缩放功能  2为图片裁剪功能   3,为图片加图片水印功能</span><br><span class="line">	private $job_types = array(&apos;scaling&apos; =&gt; 1, &apos;clipping&apos; =&gt; 2, &apos;watermark&apos; =&gt; 3, &apos;imagetext&apos; =&gt; 4);</span><br><span class="line">	private $marktext = &apos;www.ouropera.net&apos;;</span><br><span class="line">	private $fontfamily = array(&apos;arial&apos; =&gt; &apos;arial.ttf&apos;, &apos;msyh&apos; =&gt; &apos;msyh.ttc&apos;);</span><br><span class="line">	private $fontsize = 10;</span><br><span class="line">	private $allowFileType = array(&apos;gif&apos; =&gt; 1, &apos;jpg&apos; =&gt; 2, &apos;jpeg&apos; =&gt; 2, &apos;png&apos; =&gt; 3);</span><br><span class="line">	//1=GIF,2=JPG,3=PNG,4=SWF,5=PSD,6=BMP,7=TIFF(intel byte order),8=TIFF(motorola byte order),9=JPC,10=JP2,11=JPX,12=JB2,13=SWC,14=IFF,15=WBMP,16=XBM</span><br><span class="line">	private $imgtype; //图片的格式</span><br><span class="line">	private $image; //图片资源</span><br><span class="line">	private $width; //图片宽度</span><br><span class="line">	private $height; //图片高度</span><br><span class="line">	private $job; //将要对图片进行处理的工作</span><br><span class="line">	private $scaling_width; //缩放功能:宽度</span><br><span class="line">	private $scaling_height; //缩放功能:高度</span><br><span class="line">	private $position_x; //裁剪功能:x</span><br><span class="line">	private $position_y; //裁剪功能:y</span><br><span class="line">	private $clipping_width; //裁剪功能:宽度</span><br><span class="line">	private $clipping_height; //裁剪功能:高度</span><br><span class="line">	private $sourceaddress;</span><br><span class="line">	private $endaddress; //输出后的地址+文件名</span><br><span class="line">	private $suffix = &apos;_copy&apos;; //词尾后缀</span><br><span class="line">	private $target = array();</span><br><span class="line">	/**</span><br><span class="line">	 * 构造函数</span><br><span class="line">	 * @param [type] $sourceaddress [description]</span><br><span class="line">	 * @param [type] $job           [description]</span><br><span class="line">	 * @param string $endaddress    [description]</span><br><span class="line">	 */</span><br><span class="line">	function __construct($sourceaddress, $job = null, $endaddress = &quot;&quot;) &#123;</span><br><span class="line">		$this-&gt;sourceaddress = $sourceaddress;</span><br><span class="line">		$this-&gt;image = $this-&gt;imagesources($sourceaddress);</span><br><span class="line">		if (empty($job) &amp;&amp; count($job) == 0) &#123;</span><br><span class="line">			print &apos;no image filter job to do[0]!&apos;;</span><br><span class="line">			exit;</span><br><span class="line">		&#125;</span><br><span class="line">		$this-&gt;width = $this-&gt;imageWidth();</span><br><span class="line">		$this-&gt;height = $this-&gt;imageHeight();</span><br><span class="line">		$this-&gt;job = $job;</span><br><span class="line">		$this-&gt;endaddress = $this-&gt;targetImage($endaddress);</span><br><span class="line">	&#125;</span><br><span class="line">	function __destruct() &#123;</span><br><span class="line">		imagedestroy($this-&gt;image);</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 检测目标图像后缀</span><br><span class="line">	 * @param  [string] $endaddress 目标地址+文件名</span><br><span class="line">	 * @return [type] 目标地址+文件名</span><br><span class="line">	 */</span><br><span class="line">	private function targetImage($endaddress = &quot;&quot;) &#123;</span><br><span class="line">		if (empty($endaddress)) &#123;</span><br><span class="line">			$path = substr($this-&gt;sourceaddress, 0, strrpos($this-&gt;sourceaddress, &apos;.&apos;));</span><br><span class="line">			$ext = substr($this-&gt;sourceaddress, strrpos($this-&gt;sourceaddress, &apos;.&apos;) + 1);</span><br><span class="line">			$endaddress = $path . $suffix . &apos;.&apos; . $ext;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			$path = substr($endaddress, 0, strrpos($endaddress, &apos;.&apos;));</span><br><span class="line">			$ext = substr($endaddress, strrpos($endaddress, &apos;.&apos;) + 1);</span><br><span class="line">		&#125;</span><br><span class="line">		$ext = strtolower($ext);</span><br><span class="line">		if (array_key_exists($ext, $this-&gt;allowFileType)) &#123;</span><br><span class="line">			$this-&gt;target[&apos;path&apos;] = $path;</span><br><span class="line">			$this-&gt;target[&apos;ext&apos;] = $ext;</span><br><span class="line">			$this-&gt;target[&apos;type&apos;] = $this-&gt;allowFileType[$ext];</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			print &apos;Invalid file format upload attempt&apos;;</span><br><span class="line">			exit;</span><br><span class="line">		&#125;</span><br><span class="line">		return $endaddress;</span><br><span class="line">	&#125;</span><br><span class="line">	function outimage() &#123;</span><br><span class="line">		$i = 0;</span><br><span class="line">		foreach ($this-&gt;job_types as $job_name =&gt; $job_level) &#123;</span><br><span class="line">			if (isset($this-&gt;job[$job_name])) &#123;</span><br><span class="line">				$this-&gt;image = $this-&gt;$job_name($this-&gt;job[$job_name]);</span><br><span class="line">				$i++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if ($i &gt; 0) &#123;</span><br><span class="line">			$this-&gt;output($this-&gt;image);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			print &apos;no match image filter job to do!&apos;;</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 图片裁剪功能</span><br><span class="line">	 * @param  [obj] $args 参数对象</span><br><span class="line">	 * @return [obj] 返回图像对象</span><br><span class="line">	 */</span><br><span class="line">	private function clipping($args = null) &#123;</span><br><span class="line">		//将传进来的值分别赋给变量</span><br><span class="line">		if (empty($args[&apos;position&apos;])) &#123;</span><br><span class="line">			print &apos;no args:position&apos;;</span><br><span class="line">			exit;</span><br><span class="line">		&#125;</span><br><span class="line">		if (empty($args[&apos;size&apos;])) &#123;</span><br><span class="line">			print &apos;no args:size&apos;;</span><br><span class="line">			exit;</span><br><span class="line">		&#125;</span><br><span class="line">		list($src_x, $src_y) = explode(&quot;,&quot;, $args[&apos;position&apos;]);</span><br><span class="line">		list($dst_w, $dst_h) = explode(&quot;,&quot;, $args[&apos;size&apos;]);</span><br><span class="line">		if ($this-&gt;width &lt; $src_x + $dst_w || $this-&gt;height &lt; $src_y + $dst_h) &#123;</span><br><span class="line">			//这个判断就是限制不能截取到图片外面去</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">		//创建新的画布资源</span><br><span class="line">		$newimg = imagecreatetruecolor($dst_w, $dst_h);</span><br><span class="line">		//进行裁剪</span><br><span class="line">		imagecopyresampled($newimg, $this-&gt;image, 0, 0, $src_x, $src_y, $dst_w, $dst_h, $dst_w, $dst_h);</span><br><span class="line">		//调用输出方法保存</span><br><span class="line">		return $newimg;</span><br><span class="line">		//$this-&gt;output($newimg);</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 图片缩放功能</span><br><span class="line">	 * @param  [obj] $args 参数对象</span><br><span class="line">	 * @return [obj] 返回图像对象</span><br><span class="line">	 */</span><br><span class="line">	private function scaling($args = null) &#123;</span><br><span class="line">		if (empty($args[&apos;size&apos;])) &#123;</span><br><span class="line">			print &apos;no args input!&apos;;</span><br><span class="line">			exit;</span><br><span class="line">		&#125;</span><br><span class="line">		list($scaling_width, $scaling_height) = explode(&apos;,&apos;, $args[&apos;size&apos;]);</span><br><span class="line">		$this-&gt;scaling_width = (int) $scaling_width;</span><br><span class="line">		$this-&gt;scaling_height = (int) $scaling_height;</span><br><span class="line">		//获取等比缩放的宽和高</span><br><span class="line">		$this-&gt;proimagesize();</span><br><span class="line">		//根据参数进行缩放,并调用输出函数保存处理后的文件</span><br><span class="line">		//$this-&gt;output($this-&gt;imagescaling());</span><br><span class="line">		return $this-&gt;imagescaling();</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 获取图片类型并打开图像资源</span><br><span class="line">	 * @param  [string] $imgad 图像地址</span><br><span class="line">	 * @return [type]        [description]</span><br><span class="line">	 */</span><br><span class="line">	private function imagesources($imgad) &#123;</span><br><span class="line">		$imagearray = $this-&gt;getimagearr($imgad);</span><br><span class="line">		switch ($imagearray[2]) &#123;</span><br><span class="line">//1=GIF,2=JPG,3=PNG,4=SWF,5=PSD,6=BMP,7=TIFF(intel byte order),8=TIFF(motorola byte order),9=JPC,10=JP2,11=JPX,12=JB2,13=SWC,14=IFF,15=WBMP,16=XBM</span><br><span class="line">		case 1: //gif</span><br><span class="line">			$this-&gt;imgtype = 1;</span><br><span class="line">			$img = imagecreatefromgif($imgad);</span><br><span class="line">			break;</span><br><span class="line">		case 2: //jpeg</span><br><span class="line">			$this-&gt;imgtype = 2;</span><br><span class="line">			$img = imagecreatefromjpeg($imgad);</span><br><span class="line">			break;</span><br><span class="line">		case 3: //png</span><br><span class="line">			$this-&gt;imgtype = 3;</span><br><span class="line">			$img = imagecreatefrompng($imgad);</span><br><span class="line">			break;</span><br><span class="line">		default:</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">		return $img;</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 加图片水印功能</span><br><span class="line">	 * @param  [obj] $args 参数对象</span><br><span class="line">	 * @return [obj] 返回图像对象</span><br><span class="line">	 */</span><br><span class="line">	private function watermark($args = null) &#123;</span><br><span class="line">		//用函数获取水印文件的长和宽</span><br><span class="line">		$mark_file = $args[&apos;mark&apos;];</span><br><span class="line">		$imagearrs = $this-&gt;getimagearr($mark_file);</span><br><span class="line">		//调用函数计算出水印加载的位置</span><br><span class="line">		$positionarr = $this-&gt;position($args[&apos;position&apos;], $imagearrs[0], $imagearrs[1]);</span><br><span class="line">		//加水印</span><br><span class="line">		imagecopy($this-&gt;image, $this-&gt;imagesources($mark_file), $positionarr[0], $positionarr[1], 0, 0, $imagearrs[0], $imagearrs[1]);</span><br><span class="line">		//调用输出方法保存</span><br><span class="line">		return $this-&gt;image;</span><br><span class="line">		//$this-&gt;output($this-&gt;image);</span><br><span class="line">	&#125;</span><br><span class="line">	private function imagetext($args = null) &#123;</span><br><span class="line">		$text = empty($args[&apos;text&apos;]) ? $this-&gt;$marktext : $args[&apos;text&apos;];</span><br><span class="line">		$font = empty($args[&apos;fontfamily&apos;]) ? $this-&gt;fontfamily[0] : $this-&gt;fontfamily[$args[&apos;fontfamily&apos;]];</span><br><span class="line">		$fontsize = empty($args[&apos;fontsize&apos;]) ? $this-&gt;fontsize : (int) $args[&apos;fontsize&apos;];</span><br><span class="line">		$tb = imagettfbbox($fontsize, 0, $font, $text);</span><br><span class="line">		// Create some colors</span><br><span class="line">		$white = imagecolorallocate($this-&gt;image, 255, 255, 255);</span><br><span class="line">		$grey = imagecolorallocate($this-&gt;image, 128, 128, 128);</span><br><span class="line">		$black = imagecolorallocate($this-&gt;image, 0, 0, 0);</span><br><span class="line">		// Add some shadow to the text</span><br><span class="line">		imagettftext($this-&gt;image, $fontsize, 0, $this-&gt;imageWidth() - $tb[2] - 4, $this-&gt;imageHeight() - 5, $grey, $font, $text);</span><br><span class="line">		// Add the text</span><br><span class="line">		imagettftext($this-&gt;image, $fontsize, 0, $this-&gt;imageWidth() - $tb[2] - 5, $this-&gt;imageHeight() - 5, $white, $font, $text);</span><br><span class="line">		//imagepng($this-&gt;image);</span><br><span class="line">		return $this-&gt;image;</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 获得图片宽度</span><br><span class="line">	 * @return [type] [description]</span><br><span class="line">	 */</span><br><span class="line">	private function imageWidth() &#123;</span><br><span class="line">		return imagesx($this-&gt;image);</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 获取图片高度</span><br><span class="line">	 * @return [type] [description]</span><br><span class="line">	 */</span><br><span class="line">	private function imageHeight() &#123;</span><br><span class="line">		return imagesy($this-&gt;image);</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 计算等比缩放的图片的宽和高</span><br><span class="line">	 * @return [type] [description]</span><br><span class="line">	 */</span><br><span class="line">	private function proimagesize() &#123;</span><br><span class="line">		if ($this-&gt;scaling_height &amp;&amp; ($this-&gt;width &lt; $this-&gt;height)) &#123;</span><br><span class="line">//等比缩放算法</span><br><span class="line">			$this-&gt;scaling_width = round(($this-&gt;scaling_height / $this-&gt;height) * $this-&gt;width);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			$this-&gt;scaling_height = round(($this-&gt;scaling_width / $this-&gt;width) * $this-&gt;height);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 图像缩放功能,返回处理后的图像资源</span><br><span class="line">	 * @return [type] [description]</span><br><span class="line">	 */</span><br><span class="line">	private function imagescaling() &#123;</span><br><span class="line">		$newimg = imagecreatetruecolor($this-&gt;scaling_width, $this-&gt;scaling_height);</span><br><span class="line">		$tran = imagecolortransparent($this-&gt;image); //处理透明算法</span><br><span class="line">		if ($tran &gt;= 0 &amp;&amp; $tran &lt; imagecolorstotal($this-&gt;image)) &#123;</span><br><span class="line">			$tranarr = imagecolorsforindex($this-&gt;image, $tran);</span><br><span class="line">			$newcolor = imagecolorallocate($newimg, $tranarr[&apos;red&apos;], $tranarr[&apos;green&apos;], $tranarr[&apos;blue&apos;]);</span><br><span class="line">			imagefill($newimg, 0, 0, $newcolor);</span><br><span class="line">			imagecolortransparent($newimg, $newcolor);</span><br><span class="line">		&#125;</span><br><span class="line">		imagecopyresampled($newimg, $this-&gt;image, 0, 0, 0, 0, $this-&gt;scaling_width, $this-&gt;scaling_height, $this-&gt;width, $this-&gt;height);</span><br><span class="line">		return $newimg;</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 输出图像</span><br><span class="line">	 * @param  [obj] $image 图像对象</span><br><span class="line">	 * @return [type]        [description]</span><br><span class="line">	 */</span><br><span class="line">	private function output($image) &#123;</span><br><span class="line">		$targetImageType = $this-&gt;target[&apos;type&apos;];</span><br><span class="line">		switch ($targetImageType) &#123;</span><br><span class="line">		case 1:</span><br><span class="line">			imagegif($image, $this-&gt;endaddress);</span><br><span class="line">			break;</span><br><span class="line">		case 2:</span><br><span class="line">			imagejpeg($image, $this-&gt;endaddress, 95);</span><br><span class="line">			break;</span><br><span class="line">		case 3:</span><br><span class="line">			imagepng($image, $this-&gt;endaddress);</span><br><span class="line">			break;</span><br><span class="line">		default:</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 返回图像属性数组方法</span><br><span class="line">	 * @param  [type] $imagesou [description]</span><br><span class="line">	 * @return [type]           [description]</span><br><span class="line">	 */</span><br><span class="line">	private function getimagearr($imagesou) &#123;</span><br><span class="line">		return getimagesize($imagesou);</span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	 * 根据传入的数字返回一个位置的坐标,$width和$height分别代表插入图像的宽和高</span><br><span class="line">	 * @param  [int] $num    位置</span><br><span class="line">	 * @param  [int] $width  图像的宽</span><br><span class="line">	 * @param  [int] $height 图像的高</span><br><span class="line">	 * @return [type]         [description]</span><br><span class="line">	 */</span><br><span class="line">	private function position($num, $width, $height) &#123;</span><br><span class="line">//</span><br><span class="line">		switch ($num) &#123;</span><br><span class="line">		case 1:</span><br><span class="line">			$positionarr[0] = 0;</span><br><span class="line">			$positionarr[1] = 0;</span><br><span class="line">			break;</span><br><span class="line">		case 2:</span><br><span class="line">			$positionarr[0] = ($this-&gt;width - $width) / 2;</span><br><span class="line">			$positionarr[1] = 0;</span><br><span class="line">			break;</span><br><span class="line">		case 3:</span><br><span class="line">			$positionarr[0] = $this-&gt;width - $width;</span><br><span class="line">			$positionarr[1] = 0;</span><br><span class="line">			break;</span><br><span class="line">		case 4:</span><br><span class="line">			$positionarr[0] = 0;</span><br><span class="line">			$positionarr[1] = ($this-&gt;height - $height) / 2;</span><br><span class="line">			break;</span><br><span class="line">		case 5:</span><br><span class="line">			$positionarr[0] = ($this-&gt;width - $width) / 2;</span><br><span class="line">			$positionarr[1] = ($this-&gt;height - $height) / 2;</span><br><span class="line">			break;</span><br><span class="line">		case 6:</span><br><span class="line">			$positionarr[0] = $this-&gt;width - $width;</span><br><span class="line">			$positionarr[1] = ($this-&gt;height - $height) / 2;</span><br><span class="line">			break;</span><br><span class="line">		case 7:</span><br><span class="line">			$positionarr[0] = 0;</span><br><span class="line">			$positionarr[1] = $this-&gt;height - $height;</span><br><span class="line">			break;</span><br><span class="line">		case 8:</span><br><span class="line">			$positionarr[0] = ($this-&gt;width - $width) / 2;</span><br><span class="line">			$positionarr[1] = $this-&gt;height - $height;</span><br><span class="line">			break;</span><br><span class="line">		case 9:</span><br><span class="line">			$positionarr[0] = $this-&gt;width - $width;</span><br><span class="line">			$positionarr[1] = $this-&gt;height - $height;</span><br><span class="line">			break;</span><br><span class="line">		case 0:</span><br><span class="line">			$positionarr[0] = rand(0, $this-&gt;width - $width);</span><br><span class="line">			$positionarr[1] = rand(0, $this-&gt;height - $height);</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">		return $positionarr;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以对文件进行修改， imagecopy 的孪生兄弟方法 imagecopymerge比其多一个参数，用来给jpeg格式的图片提供透明度加成，但是用在png格式的图片上，会有错误。</p><p>若想让水印透明，让水印图本身透明即可。</p><p>使用方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$job = array(&apos;scaling&apos;=&gt;[&apos;size&apos;=&gt;&quot;300,500&quot;],</span><br><span class="line"> &apos;clipping&apos;=&gt;[&apos;position&apos;=&gt;&apos;0,0&apos;, &apos;size&apos;=&gt;&apos;150,50&apos;],</span><br><span class="line"> &apos;watermark&apos;=&gt;[&apos;mark&apos;=&gt;&apos;logo.png&apos;,&apos;position&apos;=&gt;0]</span><br><span class="line"> &apos;imagetext&apos;=&gt;[&apos;text&apos;=&gt;&apos;ouropera.net&apos;,&apos;fontsize&apos;=&gt;&apos;10&apos;,&apos;fontfamily&apos;=&gt;&apos;msyh&apos;]);    	</span><br><span class="line"> $image = new ImageFilter(&quot;1.jpg&quot;, $job, &quot;1_1.jpg&quot;); </span><br><span class="line"> $image-&gt;outimage();</span><br></pre></td></tr></table></figure><p>当然，可以改，看得懂源码，想怎么改就可以怎么改。</p><p>以上。</p><div class="post-announce">感谢您的阅读，本文由 <a href="https://lyubingo.github.io">Lyubingo blog</a> 版权所有。如若转载，请注明出处：Lyubingo blog（<a href="https://lyubingo.github.io/2019/04/10/16关键词and给图片加水印/">https://lyubingo.github.io/2019/04/10/16关键词and给图片加水印/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2019/03/20/15yum安装php72/" title="15yum安装php72"><i class="iconfont icon-prev"></i>15yum安装php72</a></div><div class="post__prev post__prev--right"></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">个人博客，用于分享一些在日常学习工作甚至于生活中遇到的一些比较有趣的东西。七荤八素，胡言乱语，望各位看官见谅。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2019/04/10/16关键词and给图片加水印/" title="关键词过滤&&给图片添加水印"><div class="item__cover"><img src="https://lyubingo.github.io/img/mac.jpg" alt="关键词过滤&&给图片添加水印"></div><div class="item__info"><h3 class="item__title">关键词过滤&&给图片添加水印</h3><span class="item__text">2019-04-10</span></div></a></li><li class="latest-post-item"><a href="/2019/03/20/15yum安装php72/" title="15yum安装php72"><div class="item__cover"><img src="https://lyubingo.github.io/img/mac.jpg" alt="15yum安装php72"></div><div class="item__info"><h3 class="item__title">15yum安装php72</h3><span class="item__text">2019-03-20</span></div></a></li><li class="latest-post-item"><a href="/2019/03/20/14源码安装MySQL5.7/" title="14源码安装Mysql5.7"><div class="item__cover"><img src="https://lyubingo.github.io/img/mac.jpg" alt="14源码安装Mysql5.7"></div><div class="item__info"><h3 class="item__title">14源码安装Mysql5.7</h3><span class="item__text">2019-03-20</span></div></a></li><li class="latest-post-item"><a href="/2019/03/20/13CentOs7.4（2019年）安装nginx/" title="CentOS7.4(2019年)安装nginx"><div class="item__cover"><img src="https://lyubingo.github.io/img/mac.jpg" alt="CentOS7.4(2019年)安装nginx"></div><div class="item__info"><h3 class="item__title">CentOS7.4(2019年)安装nginx</h3><span class="item__text">2019-03-20</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/hexo-github/">hexo github</a></li><li class="tag-item"><a class="tag-link" href="/tags/laravel/">laravel</a></li><li class="tag-item"><a class="tag-link" href="/tags/mac/">mac</a></li><li class="tag-item"><a class="tag-link" href="/tags/仓库/">仓库</a></li><li class="tag-item"><a class="tag-link" href="/tags/小程序/">小程序</a></li><li class="tag-item"><a class="tag-link" href="/tags/工作日常/">工作日常</a></li><li class="tag-item"><a class="tag-link" href="/tags/抱歉/">抱歉</a></li><li class="tag-item"><a class="tag-link" href="/tags/搭建环境/">搭建环境</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Changsha, Hunan Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>lyubingo@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="http://www.hncryp.com/lyubingowechat.png" alt="logo" title="Lyubingo blog"></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="hexo-theme-skapp" target="_blank">hexo-theme-skapp</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">构建工具</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://lyubingo.github.io" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:lyubingo@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>